<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Roulette del Caff√® ‚òï</title>
  <!-- PWA basics -->
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">
  <!-- iOS specific -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Roulette Caff√®">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
  <style>
    :root{
      --bg:#0f172a;         /* sfondo scuro */
      --panel:#111827;      /* pannello */
      --text:#e5e7eb;       /* testo chiaro */
      --muted:#9ca3af;      /* testo secondario */
      --primary:#22c55e;    /* pulsante primario */
      --primary-700:#16a34a;
      --accent:#06b6d4;     /* evidenze */
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html, body { height: 100%; }
    body{
      margin:0;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1000px 600px at 50% -10%, #1f2937 0%, var(--bg) 60%), var(--bg);
      color:var(--text);
      min-height:100svh;
      display:grid;
      place-items:center;
      padding:24px;
    }
    .app{
      width:min(1100px, 100%);
      display:grid;
      gap:20px;
      grid-template-columns: 380px 1fr;
    }
    @media (max-width: 900px){
      .app{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, #0b1220 0%, var(--panel) 100%);
      border:1px solid #1f2937;
      border-radius:16px;
      padding:18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    h1{ margin:0 0 4px; font-size: clamp(20px, 2.5vw, 28px); letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:14px; margin-bottom:14px;}

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .pill{ border:1px solid #1f2937; background:#0b1220; border-radius:999px; display:inline-flex; align-items:center; gap:8px; padding:8px 10px; }
    .counter{ display:inline-flex; align-items:center; gap:8px; }
    .counter .num{ min-width:28px; text-align:center; font-weight:700; }
    .iconbtn{ width:28px; height:28px; display:grid; place-items:center; border-radius:8px; border:1px solid #1f2937; background:#0b1220; color:#d1d5db; cursor:pointer; }
    .iconbtn:active{ transform: translateY(1px); }
    .range{ display:flex; align-items:center; gap:8px; }
    .range input{ accent-color: var(--primary); }

    .inputs{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .inputs{ grid-template-columns:1fr; } }
    .field{ display:flex; gap:6px; align-items:center; }
    .field label{ min-width:26px; height:26px; display:grid; place-items:center; border-radius:6px; background:#0b1220; border:1px solid #1f2937; color:#93c5fd; font-weight:600; font-size:12px; }
    .field input{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid #243244; background:#0b1220; color:var(--text); outline:none; }
    .field input.error{ border-color:#b91c1c; box-shadow: 0 0 0 2px rgba(239,68,68,.15) inset; }

    .actions{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    .btn{ appearance:none; border:none; border-radius:999px; padding:10px 16px; font-weight:700; cursor:pointer; transition:.15s transform, .15s filter; display:inline-flex; align-items:center; gap:8px; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn:hover{ filter:brightness(1.05); transform: translateY(-1px); }
    .btn.primary{ background:linear-gradient(180deg, var(--primary), var(--primary-700)); color:#062e0e;}
    .btn.secondary{ background:#0b1220; border:1px solid #1f2937; color:#d1d5db;}
    .btn.danger{ background: linear-gradient(180deg, #f87171, var(--danger)); color:#3a0a0a;}

    .badge{ display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:6px 10px; font-size:12px; font-weight:700; }
    .badge.warn{ background: rgba(245,158,11,.14); color:#fde68a; border:1px solid rgba(245,158,11,.35); }
    .badge.ok{ background: rgba(34,197,94,.14); color:#bbf7d0; border:1px solid rgba(34,197,94,.35); }

    .wheel-wrap{ position:relative; display:grid; place-items:center; padding:10px; min-height:520px; }
    #wheel{ width:min(520px, 90vw); height:min(520px, 90vw); background:#0b1220; border-radius:50%; border:2px solid #1f2937; box-shadow: inset 0 0 60px rgba(0,0,0,.35), 0 30px 80px rgba(0,0,0,.45); transform: rotate(0deg); transition: transform 0s; will-change: transform; }
    .pointer{ position:absolute; top:10px; left:50%; transform: translateX(-50%); width:0; height:0; border-left:16px solid transparent; border-right:16px solid transparent; border-bottom:24px solid var(--accent); filter: drop-shadow(0 4px 8px rgba(0,0,0,.45)); }
    .hub{ position:absolute; width:82px; height:82px; border-radius:50%; background: radial-gradient(circle at 35% 35%, #ffffff, #cbd5e1 40%, #64748b 70%, #334155 100%); border:2px solid #1f2937; display:grid; place-items:center; font-weight:800; color:#0b1220; letter-spacing:.5px; box-shadow: 0 8px 24px rgba(0,0,0,.35); }

    .result{ margin-top:12px; font-size: clamp(16px, 2vw, 20px); background:#0b1220; border:1px solid #1f2937; padding:10px 12px; border-radius:10px; }
    .winner{ font-weight:800; color:#86efac; }
    .toast{ position:fixed; inset:auto 16px 16px auto; background:#052e1a; color:#bbf7d0; border:1px solid #14532d; border-radius:10px; padding:10px 14px; font-size:14px; box-shadow: 0 8px 22px rgba(0,0,0,.35); opacity:0; transform: translateY(10px); animation: pop 2.2s ease forwards; }
    @keyframes pop{ 10%{ opacity:1; transform: translateY(0); } 85%{ opacity:1; } 100%{ opacity:0; transform: translateY(6px); } }
    /* Confetti */
    .confetti{ position:fixed; inset:0; pointer-events:none; overflow:hidden; }
    .piece{ position:absolute; width:10px; height:16px; opacity:.95; will-change: transform; animation: fall linear forwards; }
    @keyframes fall{ to{ transform: translateY(110vh) rotate(540deg); } }
  </style>
</head>
<body>
  <div class="app">
    <!-- Pannello sinistro: input nomi e comandi -->
    <div class="card">
      <h1>Roulette del Caff√® ‚òï</h1>
      <div class="sub">Inserisci i nomi, scegli quante persone partecipano e premi <b>SPIN</b>.</div>

      <div class="toolbar">
        <div class="pill counter">
          <span>Partecipanti</span>
          <button class="iconbtn" id="minusBtn" title="Rimuovi">‚àí</button>
          <span class="num" id="countLbl">6</span>
          <button class="iconbtn" id="plusBtn" title="Aggiungi">+</button>
        </div>
        <div class="pill range">
          <label for="nrSlider">Blocca vincitori ultimi</label>
          <input id="nrSlider" type="range" min="0" max="3" step="1" value="1" />
          <span id="nrVal">1</span>
          <span>giri</span>
        </div>
        <span id="dupBadge" class="badge ok">Nessun doppione</span>
      </div>

      <div class="inputs" id="inputs"></div>
      <div class="actions">
        <button class="btn primary" id="spinBtn">üéØ SPIN</button>
        <button class="btn secondary" id="shuffleBtn" title="Mescola nomi nei settori">üîÄ Mescola</button>
        <button class="btn secondary" id="resetHistBtn" title="Svuota storico vincitori">‚ôªÔ∏è Reset storico</button>
        <button class="btn danger" id="clearBtn" title="Svuota i campi">üóëÔ∏è Svuota</button>
      </div>
      <div class="result" id="result">In attesa di estrazione‚Ä¶</div>
      <div class="sub" style="margin-top:8px;">Suggerimento: premi <kbd>Invio</kbd> per avviare lo spin.</div>
    </div>

    <!-- Pannello destro: ruota -->
    <div class="card wheel-wrap">
      <div class="pointer"></div>
      <canvas id="wheel" width="800" height="800" aria-label="Ruota dei nomi"></canvas>
      <div class="hub">‚òï</div>
    </div>
  </div>

  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    // ======== Utilit√† =========
    const byId = (id)=>document.getElementById(id);
    const inputsWrap = byId('inputs');
    const wheelCanvas = byId('wheel');
    const ctx = wheelCanvas.getContext('2d');
    const spinBtn = byId('spinBtn');
    const shuffleBtn = byId('shuffleBtn');
    const clearBtn = byId('clearBtn');
    const resetHistBtn = byId('resetHistBtn');
    const resultBox = byId('result');
    const confetti = byId('confetti');
    const minusBtn = byId('minusBtn');
    const plusBtn = byId('plusBtn');
    const countLbl = byId('countLbl');
    const dupBadge = byId('dupBadge');
    const nrSlider = byId('nrSlider');
    const nrVal = byId('nrVal');

    const MIN = 2, MAX = 12;             // limiti partecipanti
    let names = Array(6).fill('');       // Nomi correnti
    let order = [...Array(names.length).keys()]; // Ordine dei settori (per mescolamento)
    let currentRotation = 0;             // Rotazione accumulata in gradi
    let spinning = false;
    let recentWinners = [];              // ultimi vincitori (indici globali)
    let noRepeatWindow = 1;              // blocco doppioni (ultimi K giri)

    // Random sicuro con window.crypto
    function cryptoInt(min, max){ // inclusivo
      const range = max - min + 1;
      const buf = new Uint32Array(1);
      let x;
      const limit = Math.floor(0xFFFFFFFF / range) * range; // rejection sampling
      do { window.crypto.getRandomValues(buf); x = buf[0]; } while (x >= limit);
      return min + (x % range);
    }

    // ======== Persistenza ========
    function loadSaved(){
      try{
        const saved = JSON.parse(localStorage.getItem('roulette_caffe_state'));
        if (saved){
          if (Array.isArray(saved.names)) names = saved.names.slice(0, MAX).slice(0, Math.max(MIN, saved.count||saved.names.length));
          if (typeof saved.noRepeatWindow === 'number') noRepeatWindow = Math.min(3, Math.max(0, saved.noRepeatWindow));
          if (Array.isArray(saved.recentWinners)) recentWinners = saved.recentWinners;
        }
      }catch{}
    }
    function save(){
      localStorage.setItem('roulette_caffe_state', JSON.stringify({
        names, count: names.length, noRepeatWindow, recentWinners
      }));
    }

    // ======== UI: input nomi ========
    function renderInputs(){
      inputsWrap.innerHTML = '';
      countLbl.textContent = String(names.length);
      for (let i=0;i<names.length;i++){
        const row = document.createElement('div');
        row.className = 'field';
        const label = document.createElement('label');
        label.textContent = String(i+1);
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `Nome ${i+1}`;
        input.value = names[i] || '';
        input.autocapitalize = 'words';
        input.enterKeyHint = 'go';
        input.addEventListener('input', (e)=>{
          names[i] = e.target.value.trim();
          markDuplicates();
          save();
          drawWheel();
        });
        row.appendChild(label); row.appendChild(input);
        inputsWrap.appendChild(row);
      }
      markDuplicates();
    }

    function setCount(n){
      n = Math.max(MIN, Math.min(MAX, n));
      const old = names.length;
      if (n === old) return;
      if (n > old){
        names = names.concat(Array(n-old).fill(''));
      }else{
        names = names.slice(0, n);
        // Ripulisci storico se contiene indici tagliati
        recentWinners = recentWinners.filter(idx => idx < n);
      }
      order = [...Array(n).keys()];
      currentRotation = 0; // reset rotazione per coerenza
      renderInputs();
      drawWheel();
      save();
    }

    // ======== Duplicati nomi ========
    function markDuplicates(){
      const inputs = inputsWrap.querySelectorAll('input');
      const map = new Map();
      const dupIdx = new Set();
      for (let i=0;i<names.length;i++){
        const key = (names[i]||'').trim().toLowerCase();
        if (!key) continue;
        if (map.has(key)){
          dupIdx.add(i); dupIdx.add(map.get(key));
        }else{
          map.set(key, i);
        }
      }
      let anyDup = false;
      for (let i=0;i<inputs.length;i++){
        if (dupIdx.has(i)) { inputs[i].classList.add('error'); anyDup = true; }
        else inputs[i].classList.remove('error');
      }
      if (anyDup){
        dupBadge.textContent = 'Doppioni presenti';
        dupBadge.className = 'badge warn';
      }else{
        dupBadge.textContent = 'Nessun doppione';
        dupBadge.className = 'badge ok';
      }
      return !anyDup;
    }

    // ======== Disegno ruota su Canvas ========
    function drawWheel(){
      const N = names.length;
      const w = wheelCanvas.width, h = wheelCanvas.height;
      const cx = w/2, cy = h/2;
      const radius = Math.min(w,h)/2 - 12;
      ctx.clearRect(0,0,w,h);
      const segAngle = (2*Math.PI)/N;
      const start = -Math.PI/2; // parte dall'alto (12:00)
      const colors = ['#22c55e','#15803d','#06b6d4','#0e7490','#f59e0b','#b45309','#e879f9','#a855f7','#f43f5e','#10b981','#84cc16','#22d3ee'];

      ctx.save();
      ctx.translate(cx, cy);
      for (let i=0;i<N;i++){
        const idx = order[i];
        const a0 = start + i*segAngle;
        const a1 = a0 + segAngle;
        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,a0,a1,false);
        ctx.closePath();
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        ctx.strokeStyle = 'rgba(0,0,0,.35)';
        ctx.lineWidth = 2;
        ctx.stroke();

        const label = (names[idx] || `Persona ${idx+1}`).trim();
        ctx.save();
        const am = a0 + segAngle/2;
        ctx.rotate(am);
        ctx.translate(radius*0.66, 0);
        ctx.rotate(Math.PI/2);
        ctx.fillStyle = '#0b1220';
        ctx.font = `${Math.max(16, radius*0.06)}px ui-sans-serif, system-ui, -apple-system`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        const maxWidth = radius*0.9;
        let text = label;
        while (ctx.measureText(text).width > maxWidth && text.length > 4){
          text = text.slice(0, -2) + '‚Ä¶';
        }
        ctx.fillText(text, 0, 0);
        ctx.restore();
      }
      ctx.beginPath();
      ctx.arc(0,0,radius+4,0,2*Math.PI);
      ctx.lineWidth = 8;
      ctx.strokeStyle = '#1f2937';
      ctx.stroke();
      ctx.restore();
    }

    // ======== Confetti & Toast =========
    function launchConfetti(){
      confetti.innerHTML = '';
      const colors = ['#22c55e','#86efac','#06b6d4','#67e8f9','#f59e0b','#fde68a','#e879f9','#c084fc'];
      const pieces = 120;
      for (let i=0;i<pieces;i++){
        const d = document.createElement('div');
        d.className = 'piece';
        d.style.left = Math.random()*100 + 'vw';
        d.style.top = (-10 - Math.random()*20) + 'vh';
        d.style.background = colors[i % colors.length];
        d.style.transform = `translateY(0) rotate(${Math.random()*360}deg)`;
        d.style.animationDuration = (6 + Math.random()*3) + 's';
        confetti.appendChild(d);
        setTimeout(()=>d.remove(), 10000);
      }
    }
    function toast(msg){
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>t.remove(), 2300);
    }

    // ======== Validazioni ========
    function validate(){
      const N = names.length;
      const filled = names.map(n=>n && n.trim()).filter(Boolean);
      if (filled.length < N){ toast(`Inserisci tutti e ${N} i nomi.`); return false; }
      if (!markDuplicates()){ toast('Rimuovi i doppioni dei nomi.'); return false; }
      return true;
    }

    // ======== Logica SPIN con blocco doppioni (ultimi K) =========
    function spin(){
      if (spinning) return;
      if (!validate()) return;
      const N = names.length;
      // Crea lista settori consentiti (escludi nomi in recentWinners secondo noRepeatWindow)
      const banned = new Set(recentWinners.slice(0, noRepeatWindow));
      let allowedSectors = [];
      for (let sector=0; sector<N; sector++){
        const globalIdx = order[sector];
        if (!banned.has(globalIdx)) allowedSectors.push(sector);
      }
      if (allowedSectors.length === 0){
        // Se finestra troppo grande rispetto a N, allenta il vincolo
        allowedSectors = [...Array(N).keys()];
      }
      const winnerSector = allowedSectors[cryptoInt(0, allowedSectors.length-1)];
      const winnerGlobalIndex = order[winnerSector];
      const winnerName = names[winnerGlobalIndex];

      // Parametri animazione
      const segDeg = 360 / N;
      const centerFromTop = winnerSector * segDeg + segDeg/2; // gradi
      const fullTurns = Math.max(5, Math.min(8, cryptoInt(5, 8)));
      const jitter = (Math.random()*segDeg/3) - (segDeg/6);
      const targetMod = (360 - (centerFromTop + jitter)) % 360;
      const needMod = ( (targetMod - (currentRotation % 360)) + 360 ) % 360;
      const extra = fullTurns*360 + needMod;

      spinning = true;
      spinBtn.disabled = true; shuffleBtn.disabled = true; clearBtn.disabled = true; resetHistBtn.disabled = true;

      const duration = 4200 + Math.random()*900;
      wheelCanvas.style.transition = `transform ${duration}ms cubic-bezier(.12,.62,.02,1)`;
      currentRotation += extra;
      wheelCanvas.style.transform = `rotate(${currentRotation}deg)`;

      try{
        const ctxAudio = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctxAudio.createOscillator(); const g = ctxAudio.createGain();
        o.connect(g); g.connect(ctxAudio.destination);
        o.type = 'triangle'; o.frequency.value = 740;
        g.gain.setValueAtTime(0.0001, ctxAudio.currentTime);
        g.gain.exponentialRampToValueAtTime(0.05, ctxAudio.currentTime + 0.02);
        g.gain.exponentialRampToValueAtTime(0.0001, ctxAudio.currentTime + 0.15);
        o.start(); o.stop(ctxAudio.currentTime + 0.18);
      }catch{}

      const onEnd = ()=>{
        wheelCanvas.removeEventListener('transitionend', onEnd);
        spinning = false;
        spinBtn.disabled = false; shuffleBtn.disabled = false; clearBtn.disabled = false; resetHistBtn.disabled = false;
        wheelCanvas.style.transition = 'transform 0s';

        resultBox.innerHTML = `Vince il conto del caff√®: <span class="winner">${winnerName}</span> üéâ`;
        launchConfetti();
        // aggiorna storico vincitori
        recentWinners.unshift(winnerGlobalIndex);
        recentWinners = recentWinners.slice(0, Math.max(noRepeatWindow, 10)); // tieni un po' di storia
        save();
      };
      wheelCanvas.addEventListener('transitionend', onEnd, { once:true });
    }

    // ======== Eventi UI =========
    spinBtn.addEventListener('click', spin);
    shuffleBtn.addEventListener('click', ()=>{
      for (let i=order.length-1; i>0; i--){
        const j = cryptoInt(0, i);
        [order[i], order[j]] = [order[j], order[i]];
      }
      toast('Settori mescolati.');
      drawWheel();
    });
    clearBtn.addEventListener('click', ()=>{
      names = Array(Math.max(MIN, names.length)).fill('');
      recentWinners = [];
      currentRotation = 0;
      save();
      renderInputs();
      drawWheel();
      resultBox.textContent = 'In attesa di estrazione‚Ä¶';
    });
    resetHistBtn.addEventListener('click', ()=>{
      recentWinners = [];
      save();
      toast('Storico vincitori azzerato.');
    });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') spin(); });

    minusBtn.addEventListener('click', ()=> setCount(names.length - 1));
    plusBtn.addEventListener('click', ()=> setCount(names.length + 1));
    nrSlider.addEventListener('input', ()=>{ noRepeatWindow = parseInt(nrSlider.value,10)||0; nrVal.textContent = String(noRepeatWindow); save(); });

    // ======== Init ========
    (function init(){
      loadSaved();
      countLbl.textContent = String(names.length);
      nrSlider.value = String(noRepeatWindow); nrVal.textContent = String(noRepeatWindow);
      order = [...Array(names.length).keys()];
      renderInputs();
      drawWheel();

      if ('serviceWorker' in navigator){
        window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(console.error); });
      }
    })();
  </script>
</body>
</html>